---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import Headline from "../../../components/ui/Headline.astro";
import PostItem from "../../../components/blog/PostItem.astro";
import Schema from "../../../components/seo/Schema.astro";

export async function getStaticPaths() {
    const allPosts = await getCollection("blog");
    const posts = allPosts.filter((post) => post.data && post.data.pubDate); // Ensure published

    const categories = new Set();
    posts.forEach((post) => {
        if (post.data.category) {
            categories.add(post.data.category);
        }
    });

    return Array.from(categories).map((category) => {
        return {
            params: { category: category as string },
            props: {
                category,
                posts: posts.filter((post) => post.data.category === category),
            },
        };
    });
}

const { category, posts } = Astro.props;

const metadata = {
    title: `${category} 分类`,
    description: `查看 ${category} 分类下的文章与评测，共 ${posts.length} 篇内容。`,
    keywords: [
        "机场推荐",
        "科学上网",
        "翻墙",
        `${category}`,
        `${category} 评测`,
    ],
    canonical: Astro.url.href,
};
---

<BaseLayout metadata={metadata}>
    <Schema
        type="CollectionPage"
        data={{
            title: `${category} 分类`,
            description: `查看 ${category} 分类下的文章与评测。`,
            url: Astro.url.href,
        }}
    />
    <section class="relative px-4 py-24 sm:px-6 lg:px-8 md:py-32">
        <div class="relative mx-auto max-w-5xl">
            <Headline
                tagline="分类"
                title={category}
                subtitle={`共 ${posts.length} 篇相关文章`}
                classes={{
                    container: "mb-12 text-center",
                    title: "font-heading mb-4 text-4xl font-bold tracking-tight text-foreground md:text-6xl capitalized",
                    subtitle: "mx-auto max-w-3xl text-xl text-muted-foreground",
                }}
            />

            <div class="mb-8 text-center">
                <a href="/blog" class="text-primary hover:underline"
                    >← 返回博客</a
                >
            </div>

            <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                {
                    posts
                        .sort(
                            (a, b) =>
                                b.data.pubDate.valueOf() -
                                a.data.pubDate.valueOf(),
                        )
                        .map((post) => <PostItem post={post} />)
                }
            </div>
        </div>
    </section>
</BaseLayout>
